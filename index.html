<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>打刻</title>
  <style>
    body { font-family: system-ui; margin: 12px; background: #f5f5f5; }
    .card {
      background: #fff; padding: 16px; border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    button {
      width: 100%; padding: 16px; font-size: 20px;
      margin-top: 12px; border-radius: 8px; border: none;
      background: #1976d2; color: #fff;
    }
    button.secondary { background: #555; }
    #status { margin-top: 12px; font-size: 16px; }
  </style>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <h2>打刻</h2>

  <div class="card">
    <div id="empInfo" style="font-size:18px; margin-bottom:12px;"></div>

    <button id="btnClockIn">出勤</button>
    <button id="btnClockOut" class="secondary">退勤</button>

    <div id="status"></div>
  </div>

  <script>
      // APIキーなどの設定  
        const SUPABASE_URL = "https://xxxx.supabase.co";  // https://erasqrxlhxjzkpttlohk.supabase.co
        const SUPABASE_KEY = "public-anon-key";           // sb_publishable_hRbRNAvPFYNd9ROWgg5vrw_G_hsfjSa

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // PWA Service Worker 登録
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
async function punch(type) {
  const now = new Date();
  const date = now.toISOString().slice(0, 10);
  const time = now.toTimeString().slice(0, 5);

  // 1. 既存レコードを検索
  const { data: existing, error: selErr } = await supa
    .from("kintai")
    .select("*")
    .eq("emp_id", empId)
    .eq("date", date)
    .maybeSingle();

  if (selErr) {
    msg("エラー：" + selErr.message);
    return;
  }

  // 2. 新規 or 更新
  if (!existing) {
    // 新規
    const { error: insErr } = await supa.from("kintai").insert({
      emp_id: empId,
      name: emp.name,
      date,
      clock_in: type === "clockIn" ? time : null,
      clock_out: type === "clockOut" ? time : null
    });
    if (insErr) return msg("登録エラー：" + insErr.message);
  } else {
    // 更新
    const { error: updErr } = await supa
      .from("kintai")
      .update({
        clock_in: type === "clockIn" ? time : existing.clock_in,
        clock_out: type === "clockOut" ? time : existing.clock_out
      })
      .eq("id", existing.id);
    if (updErr) return msg("更新エラー：" + updErr.message);
  }

  msg(type === "clockIn" ? `出勤打刻しました：${time}` : `退勤打刻しました：${time}`);
}
    function msg(t) {
      document.getElementById("status").textContent = t;
    }
  </script>

</body>
</html>